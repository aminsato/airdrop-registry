package volume

import (
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/sirupsen/logrus"
	"github.com/stretchr/testify/assert"
)

func TestLifiVolume(t *testing.T) {
	mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		response := map[string]any{
			"transfers": []map[string]any{
				{
					"transactionId": "0x156e1e88469e2f0be957aa8eaf48e21326df097f22267dd4f174e87799f9fafd",
					"sending": map[string]any{
						"txHash": "0x22d229f07f74b11a68e2fdc4dc32a3dc19aff7bea0dfe377bd2b718d83e49f45",
						"txLink": "https://arbiscan.io/tx/0x22d229f07f74b11a68e2fdc4dc32a3dc19aff7bea0dfe377bd2b718d83e49f45",
						"token": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3490",
						},
						"chainId":  42161,
						"gasPrice": "10000000",
						"gasUsed":  "815688",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3490",
						},
						"gasAmount":    "8156880000000",
						"gasAmountUSD": "0.0285",
						"amountUSD":    "6.9800",
						"value":        "2025014280735355",
						"amount":       "2000000000000000",
						"timestamp":    1735113042,
					},
					"receiving": map[string]any{
						"txHash": "0xc45c36779ea11f77704080e59e51d83be11cfa35cd10cf4ccf01ed94ae71a5ca",
						"txLink": "https://basescan.org/tx/0xc45c36779ea11f77704080e59e51d83be11cfa35cd10cf4ccf01ed94ae71a5ca",
						"token": map[string]any{
							"address":  "0x6b9bb36519538e0C073894E964E90172E1c0B41F",
							"chainId":  8453,
							"symbol":   "WEWE",
							"decimals": 18,
							"name":     "UPSIDE DOWN MEME",
							"coinKey":  "WEWE",
							"logoURI":  "https://static.debank.com/image/base_token/logo_url/0x6b9bb36519538e0c073894e964e90172e1c0b41f/0472cf0cc59a32ae8b8753a051356dd9.png",
							"priceUSD": "0.000019963756534002336",
						},
						"chainId":  8453,
						"gasPrice": "7769484",
						"gasUsed":  "345021",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  8453,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3490",
						},
						"gasAmount":    "2680635139164",
						"gasAmountUSD": "0.0094",
						"amountUSD":    "6.9686",
						"value":        "0",
						"amount":       "349064972063952147077893",
						"timestamp":    1735113085,
					},
					"lifiExplorerLink": "https://scan.li.fi/tx/0x22d229f07f74b11a68e2fdc4dc32a3dc19aff7bea0dfe377bd2b718d83e49f45",
					"fromAddress":      "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"toAddress":        "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"tool":             "stargateV2",
					"status":           "DONE",
					"substatus":        "COMPLETED",
					"substatusMessage": "The transfer is complete.",
					"metadata": map[string]any{
						"integrator": "vultisig-android",
					},
				},
				{
					"transactionId": "0x04b329cf35836b95d4b8fb2649eb67d9bcae90970de8d2037ce316b18a50984a",
					"sending": map[string]any{
						"txHash": "0xb9ad24e06018844fe709f76e7ee631164f35facf3b6dd3e1ac6a01eff0468a94",
						"txLink": "https://arbiscan.io/tx/0xb9ad24e06018844fe709f76e7ee631164f35facf3b6dd3e1ac6a01eff0468a94",
						"token": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3507.01",
						},
						"chainId":  42161,
						"gasPrice": "10668000",
						"gasUsed":  "595121",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3507.01",
						},
						"gasAmount":    "6348750828000",
						"gasAmountUSD": "0.0223",
						"amountUSD":    "8.7675",
						"value":        "2527371127586676",
						"amount":       "2500000000000000",
						"timestamp":    1735107654,
					},
					"receiving": map[string]any{
						"txHash": "0xe958c8c75bddd694bfba4dfb18612fc90d171399487479bd1510c4260d80b2c6",
						"txLink": "https://basescan.org/tx/0xe958c8c75bddd694bfba4dfb18612fc90d171399487479bd1510c4260d80b2c6",
						"token": map[string]any{
							"address":  "0x6b9bb36519538e0C073894E964E90172E1c0B41F",
							"chainId":  8453,
							"symbol":   "WEWE",
							"decimals": 18,
							"name":     "UPSIDE DOWN MEME",
							"coinKey":  "WEWE",
							"logoURI":  "https://static.debank.com/image/base_token/logo_url/0x6b9bb36519538e0c073894e964e90172e1c0b41f/0472cf0cc59a32ae8b8753a051356dd9.png",
							"priceUSD": "0.000019342199956058637",
						},
						"chainId":  8453,
						"gasPrice": "7032354",
						"gasUsed":  "317219",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  8453,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3507.01",
						},
						"gasAmount":    "2230796303526",
						"gasAmountUSD": "0.0078",
						"amountUSD":    "8.6112",
						"value":        "0",
						"amount":       "445205156576714449310967",
						"timestamp":    1735107697,
					},
					"lifiExplorerLink": "https://scan.li.fi/tx/0xb9ad24e06018844fe709f76e7ee631164f35facf3b6dd3e1ac6a01eff0468a94",
					"fromAddress":      "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"toAddress":        "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"tool":             "stargateV2",
					"status":           "DONE",
					"substatus":        "COMPLETED",
					"substatusMessage": "The transfer is complete.",
					"metadata": map[string]any{
						"integrator": "vultisig-android",
					},
				},
				{
					"transactionId": "0x52eacc6bc2724716aa6b00023c35217413431a6d6492fa59dadc81def24b830f",
					"sending": map[string]any{
						"txHash": "0x95525e99536b833139ea492a79fb92c4b6677fd66457fce0faac2ed836560d54",
						"txLink": "https://arbiscan.io/tx/0x95525e99536b833139ea492a79fb92c4b6677fd66457fce0faac2ed836560d54",
						"token": map[string]any{
							"address":  "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
							"chainId":  42161,
							"symbol":   "USDC",
							"decimals": 6,
							"name":     "USD Coin",
							"coinKey":  "USDC",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png",
							"priceUSD": "1.001201441730076",
						},
						"chainId":  42161,
						"gasPrice": "10000000",
						"gasUsed":  "564956",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3294",
						},
						"gasAmount":    "5649560000000",
						"gasAmountUSD": "0.0186",
						"amountUSD":    "770.9251",
						"value":        "0",
						"amount":       "770000000",
						"timestamp":    1734918594,
					},
					"receiving": map[string]any{
						"txHash": "0x95525e99536b833139ea492a79fb92c4b6677fd66457fce0faac2ed836560d54",
						"txLink": "https://arbiscan.io/tx/0x95525e99536b833139ea492a79fb92c4b6677fd66457fce0faac2ed836560d54",
						"token": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3294",
						},
						"chainId":  42161,
						"gasPrice": "10000000",
						"gasUsed":  "564956",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3294",
						},
						"gasAmount":    "5649560000000",
						"gasAmountUSD": "0.0186",
						"amountUSD":    "769.7445",
						"value":        "0",
						"amount":       "233680777355485873",
						"timestamp":    1734918594,
					},
					"lifiExplorerLink": "https://scan.li.fi/tx/0x95525e99536b833139ea492a79fb92c4b6677fd66457fce0faac2ed836560d54",
					"fromAddress":      "0xdd3f8bc37c975cb9063e2def90b6303379e6d0cf",
					"toAddress":        "0xdd3f8bc37c975cb9063e2def90b6303379e6d0cf",
					"tool":             "1inch",
					"status":           "DONE",
					"substatus":        "COMPLETED",
					"substatusMessage": "The transfer is complete.",
					"metadata": map[string]any{
						"integrator": "vultisig-android",
					},
				},
				{
					"transactionId": "0x1ceb4670adea79685c4d2a7c7542bf29e639835b785f6e4e14ac069f4df3493a",
					"sending": map[string]any{
						"txHash": "0x4b228568d887980e959461898011780eb23dd589ab4e027d856ac96a625c32fb",
						"txLink": "https://arbiscan.io/tx/0x4b228568d887980e959461898011780eb23dd589ab4e027d856ac96a625c32fb",
						"token": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3389.14",
						},
						"chainId":  42161,
						"gasPrice": "10000000",
						"gasUsed":  "262679",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3389.14",
						},
						"gasAmount":    "2626790000000",
						"gasAmountUSD": "0.0089",
						"amountUSD":    "70.8330",
						"value":        "20900000000000000",
						"amount":       "20900000000000000",
						"timestamp":    1734868949,
					},
					"receiving": map[string]any{
						"txHash": "0xc114d933933af1837607ffa8d708861aa87a094187d1255569d1e8236326bd7d",
						"txLink": "https://etherscan.io/tx/0xc114d933933af1837607ffa8d708861aa87a094187d1255569d1e8236326bd7d",
						"token": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  1,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3380.6",
						},
						"chainId":  1,
						"gasPrice": "13355642000",
						"gasUsed":  "105192",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  1,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3380.6",
						},
						"gasAmount":    "1404906693264000",
						"gasAmountUSD": "4.7494",
						"amountUSD":    "65.3375",
						"value":        "0",
						"amount":       "19327176917041057",
						"timestamp":    1734868967,
					},
					"lifiExplorerLink": "https://scan.li.fi/tx/0x4b228568d887980e959461898011780eb23dd589ab4e027d856ac96a625c32fb",
					"fromAddress":      "0x1db953095b0dcb7b416d3254fb0bc2928ca82ad5",
					"toAddress":        "0x1db953095b0dcb7b416d3254fb0bc2928ca82ad5",
					"tool":             "across",
					"status":           "DONE",
					"substatus":        "COMPLETED",
					"substatusMessage": "The transfer is complete.",
					"metadata": map[string]any{
						"integrator": "vultisig-android",
					},
				},
				{
					"transactionId": "0xfd2c833d60e8a95df33b720aaaec1ee816e4bbf883aaef98dda13f53b18a515e",
					"sending": map[string]any{
						"txHash": "0x66b997c974391968655782fc90a143360fa09035a7a48815934bb239be95d9e3",
						"txLink": "https://arbiscan.io/tx/0x66b997c974391968655782fc90a143360fa09035a7a48815934bb239be95d9e3",
						"token": map[string]any{
							"address":  "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
							"chainId":  42161,
							"symbol":   "USDC",
							"decimals": 6,
							"name":     "USD Coin",
							"coinKey":  "USDC",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png",
							"priceUSD": "1.0002000400080016",
						},
						"chainId":  42161,
						"gasPrice": "10000000",
						"gasUsed":  "1106468",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  42161,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3876.21",
						},
						"gasAmount":    "11064680000000",
						"gasAmountUSD": "0.0429",
						"amountUSD":    "161.0322",
						"value":        "37172781913605",
						"amount":       "161000000",
						"timestamp":    1734301769,
					},
					"receiving": map[string]any{
						"txHash": "0xc6aec7b888a5cfd8743074e8f2e58531ae8569ab980b23e3405acf74d3abd1ee",
						"txLink": "https://basescan.org/tx/0xc6aec7b888a5cfd8743074e8f2e58531ae8569ab980b23e3405acf74d3abd1ee",
						"token": map[string]any{
							"address":  "0x6b9bb36519538e0C073894E964E90172E1c0B41F",
							"chainId":  8453,
							"symbol":   "WEWE",
							"decimals": 18,
							"name":     "UPSIDE DOWN MEME",
							"coinKey":  "WEWE",
							"logoURI":  "https://static.debank.com/image/base_token/logo_url/0x6b9bb36519538e0c073894e964e90172e1c0b41f/0472cf0cc59a32ae8b8753a051356dd9.png",
							"priceUSD": "0.000021635907197915943",
						},
						"chainId":  8453,
						"gasPrice": "17866826",
						"gasUsed":  "273592",
						"gasToken": map[string]any{
							"address":  "0x0000000000000000000000000000000000000000",
							"chainId":  8453,
							"symbol":   "ETH",
							"decimals": 18,
							"name":     "ETH",
							"coinKey":  "ETH",
							"logoURI":  "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png",
							"priceUSD": "3876.21",
						},
						"gasAmount":    "4888220658992",
						"gasAmountUSD": "0.0189",
						"amountUSD":    "158.1888",
						"value":        "0",
						"amount":       "7311403292527139814445478",
						"timestamp":    1734301809,
					},
					"lifiExplorerLink": "https://scan.li.fi/tx/0x66b997c974391968655782fc90a143360fa09035a7a48815934bb239be95d9e3",
					"fromAddress":      "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"toAddress":        "0x0b1a6fdd08b8e63d6b9476b971f03354823448ce",
					"tool":             "stargateV2",
					"status":           "DONE",
					"substatus":        "COMPLETED",
					"substatusMessage": "The transfer is complete.",
					"metadata": map[string]any{
						"integrator": "vultisig-android",
					},
				},
			}}
		w.WriteHeader(http.StatusOK)
		json.NewEncoder(w).Encode(response)
	}))
	defer mockServer.Close()
	li := lifiVolumeTrack{
		logger:  logrus.WithField("module", "vol_service").Logger,
		baseUrl: mockServer.URL,
	}
	expect := map[string]float64{
		"0x0b1a6fdd08b8e63d6b9476b971f03354823448ce": 173.7686,
	}
	res, err := li.processVolume(1730468849, 1735134449, "t")
	assert.NoErrorf(t, err, "Failed to get: %v", err)
	assert.Equal(t, expect["0x0b1a6fdd08b8e63d6b9476b971f03354823448ce"], res["0x0b1a6fdd08b8e63d6b9476b971f03354823448ce"])
}
